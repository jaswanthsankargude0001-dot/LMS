<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learning Management system</title>
<style>
  :root {
    --primary: #0078D7;
    --primary-dark: #005fa3;
    --bg: #f4f6f8;
    --card: #fff;
    --muted: #666;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    color: #222;
    padding-top:74px;
  }

  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: var(--primary);
    color: #fff;
    padding: 14px 18px;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  header h1 { margin: 0; font-size: 18px; font-weight: 700; }
  header small { font-size: 13px; font-style: italic; color: rgba(255,255,255,0.95); margin-left: 8px; font-weight:400; }

  .container{ display:flex; justify-content:center; align-items:center; min-height:62vh; padding:20px }
  .box{ background:var(--card); padding:22px; border-radius:10px; width:380px; box-shadow:0 6px 18px rgba(0,0,0,0.06); text-align:center }
  button { background: var(--primary); color: #fff; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 15px; }
  button.alt { background: #666; }
  .back-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
  input[type="text"], input[type="password"], input[type="file"], select { width: 82%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
  #dashboard { display: none; min-height:100vh }
  .sidebar { width: 240px; background: var(--primary-dark); color: #fff; position: fixed; left: -260px; top: 74px; bottom: 0; padding-top: 20px; transition: left .25s; z-index: 900; }
  .sidebar a { color: #fff; display: block; padding: 12px 16px; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.06); }
  .sidebar a:hover { background: var(--primary); }
  .main-content { margin-left: 0; transition: margin-left 0.25s; padding: 22px; padding-top: 28px; min-height:100vh }
  .menu-icon { font-size: 22px; color: var(--primary); cursor: pointer; margin-left: 8px; }
  #main-area { background: var(--card); padding: 18px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); min-height: 420px; }
  footer { position: relative; bottom: 0; width: 100%; background-color: #1a1a1a; color: #fff; text-align: center; padding: 30px 20px; margin-top: 30px; }
  footer p { margin: 6px 0; font-size: 14px; }
  footer h2 { margin-top: 10px; font-size: 18px; font-weight: 700; }
  footer span { font-size: 13px; font-style: italic; color: rgba(255,255,255,0.95); margin-left: 8px; font-weight: 400; }
  @media (max-width: 768px) {
    .box { width: 90%; }
    .main-content { padding-left: 10px; padding-right: 10px; padding-bottom: 120px; }
  }
  .resource-list li{padding:10px;margin:8px 0;border-radius:8px;background:#f8fafc;display:flex;justify-content:space-between;align-items:center}
  .small-btn{background:transparent;border:1px solid var(--primary);color:var(--primary);padding:6px 10px;border-radius:6px;cursor:pointer;margin-left:6px;text-decoration:none}
  .categories,.subcats{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .cat-btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
  .upload-form{margin-top:12px;display:flex;flex-direction:column;align-items:center;gap:8px}
  .meta{font-size:12px;color:var(--muted);margin-left:8px}
  .preview{border-radius:8px;padding:12px;background:#fcfdff;border:1px solid #e6eefb;margin-bottom:12px}
  .close-preview{background:transparent;border:1px solid #ccc;padding:6px 10px;border-radius:6px;cursor:pointer}
  a.link-btn{background:transparent;border:1px solid var(--primary);color:var(--primary);padding:6px 10px;border-radius:6px;cursor:pointer;text-decoration:none;margin-left:6px}
</style>

</head>
<body>

<header>
  <h1>Learning Management System</h1>
  <small>‚Äî Developed by Jaswanth Sankar (M.Sc. Computer Science)</small>
</header>

<!-- HOME: role selection -->
<div class="container" id="home">
  <div class="box">
    <h2>Welcome!</h2>
    <p>Select your role</p>
    <div style="display:flex;justify-content:center;gap:12px;margin-top:12px">
      <button onclick="openLogin('student')">Student</button>
      <button onclick="openLogin('teacher')">Teacher</button>
    </div>
    <p style="font-size:13px;color:#555;margin-top:12px">Use signup to create a local account (stored in browser).</p>
  </div>
</div>

<!-- AUTH (login/signup) -->
<div class="container" id="authPage" style="display:none">
  <div class="box">
    <h2 id="formTitle">Login</h2>
    <div style="position:absolute; right:18px; top:86px;">
      <button class="back-btn" onclick="goBack()">üîô Back</button>
    </div>
    <input type="text" id="username" placeholder="Enter username" />
    <input type="password" id="password" placeholder="Enter password" />
    <div style="display:flex;justify-content:center;gap:10px;margin-top:8px">
      <button onclick="handleAuth()">Login</button>
      <button onclick="toggleForm()" class="alt">Signup</button>
    </div>
    <span class="forgot" onclick="forgotPassword()" style="display:block;margin-top:8px;color:var(--primary);cursor:pointer">Forgot Password?</span>
    <p id="signupNote" style="font-size:13px;color:#444;margin-top:8px">Don't have account? Click Signup button above.</p>
  </div>
</div>

<!-- DASHBOARD (single page app area) -->
<div id="dashboard">
  <div class="sidebar" id="sidebar">
    <a href="#" onclick="loadContent('materials')">üìò Study Materials</a>
    <a href="#" onclick="loadContent('videos')">üé• Videos</a>
    <a href="#" onclick="loadContent('tasks')">üìù Tasks</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
  </div>

  <div class="main-content" id="mainContent">
    <span class="menu-icon" onclick="toggleMenu()">‚ò∞</span>
    <div id="main-area">
      <h2>Welcome to our online learning Management system</h2>
      <p>Select an option from the sidebar.</p>
    </div>
  </div>
</div>

<!-- Footer Section -->
<footer>
  <p>Learn skills that shape your future and open new career opportunities.</p>
  <p>üìû +91 8074342346 | ‚úâÔ∏è jaswanthsankargude0001@gmail.com</p>
  <p>¬© 2025 All Rights Reserved.</p>
  <h2>Learning Management System</h2>
  <span>‚Äî Developed by Jaswanth Sankar (M.Sc. Computer Science)</span>
</footer>

<script>
/* ---------- CONFIG ---------- */
const MOCKAPI_URL = "https://6906e95cb1879c890ed84ed3.mockapi.io/materials";

/* ---------- UTIL ---------- */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatDate(iso){ try{ return new Date(iso).toLocaleString(); }catch(e){ return iso; } }
function readFileAsDataURL(file){ return new Promise((res, rej) => { const fr = new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); }); }

/* ---------- APP STATE ---------- */
let role = ""; // 'student' or 'teacher'
let isLogin = true;
let sidebarVisible = false;

/* ---------- CATEGORIES ---------- */
const CATEGORIES = {
  frontend: { label: "Frontend", subs: ["html","css","js","frameworks"] },
  backend: { label: "Backend", subs: ["C","python","java"] },
  database: { label: "Database", subs: ["sql","nosql"] },
  ai: { label: "AI/ML", subs: ["ai","ml","dl"] },
  ds: { label: "Data Analytics", subs: ["Excel","sql1","python1","Power Bi"] },
  cc: { label: "cloud computing", subs: ["ntg bayya"] },
  cs: { label: "Cyber security", subs: ["ntg bayya"] }
};
const SUB_LABELS = {
  html: "HTML", css:"CSS", js:"JavaScript", frameworks:"Libraries & Frameworks",
  node:"Node.js", python:"Python/Django", java:"Java/Spring", sql:"SQL (MySQL/Postgres)", nosql:"NoSQL (MongoDB)",
  ai:"AI",ml:"ML",dl:"DL", python1:"Numpy & Pandas", sql1:"SQL"
};

/* ---------- AUTH ---------- */
function openLogin(selectedRole) {
  role = selectedRole;
  document.getElementById("home").style.display = "none";
  document.getElementById("authPage").style.display = "flex";
  document.getElementById("formTitle").innerText = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
  isLogin = true;
  const sn = document.getElementById("signupNote");
  if(role === "teacher") sn.style.display = "none"; else sn.style.display = "block";
}
function goBack(){ document.getElementById("authPage").style.display = "none"; document.getElementById("home").style.display = "flex"; }
function toggleForm(){
  if(role === "teacher"){ alert("Teacher cannot signup. Use predefined credentials."); return; }
  isLogin = !isLogin;
  document.getElementById("formTitle").innerText = `${role.charAt(0).toUpperCase() + role.slice(1)} ${isLogin ? "Login" : "Signup"}`;
  const sn = document.getElementById("signupNote"); sn.style.display = isLogin ? "block" : "none";
}
function forgotPassword(){
  const username = prompt("Enter your username for password retrieval:");
  if(!username) return alert("Username required.");
  const key = `${role}_${username}`;
  const stored = localStorage.getItem(key);
  if(!stored) return alert("User not found!");
  const user = JSON.parse(stored);
  alert(`Password for ${username}: ${user.password}`);
}
function handleAuth(){
  const username = (document.getElementById("username").value||"").trim();
  const password = (document.getElementById("password").value||"").trim();
  if(!username || !password) return alert("Enter username and password.");

  const predefinedTeachers = [
    { username: "teacher1", password: "67890" },
    { username: "teacher2", password: "abcde" },
    { username: "jassuuu", password: "12345" }
  ];

  if(role === "teacher"){
    const validTeacher = predefinedTeachers.find(t => t.username === username && t.password === password);
    if(validTeacher){
      localStorage.setItem("current_user", "teacher_" + username);
      alert(`Welcome ${username}! Login successful.`);
      openDashboard();
    } else alert("Invalid teacher credentials!");
    return;
  }

  const key = `${role}_${username}`;
  if(isLogin){
    const stored = localStorage.getItem(key);
    if(!stored) return alert("Account not found. Signup first.");
    const user = JSON.parse(stored);
    if(user.password !== password) return alert("Incorrect password.");
    localStorage.setItem("current_user", key);
    openDashboard();
  } else {
    if(localStorage.getItem(key)) return alert("User already exists. Login instead.");
    localStorage.setItem(key, JSON.stringify({ username, password, role }));
    alert("Account created. You can now login.");
    isLogin = true;
    document.getElementById("formTitle").innerText = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
  }
}
/* ---------- UI Router ---------- */
function openDashboard(){
  document.getElementById("authPage").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  const cur = localStorage.getItem("current_user") || "";
  const uname = cur.split("_").slice(1).join("_");
  if(document.getElementById("main-area")){
    document.getElementById("main-area").innerHTML = `<h2>Welcome ${escapeHtml(uname || "")}</h2><p>Click the sections above to navigate. For extra options, click the three lines on top.</p>`;
  }
}
function toggleMenu(){
  const sb = document.getElementById("sidebar");
  const mc = document.getElementById("mainContent");
  if(!sb || !mc) return;
  if(sidebarVisible){ sb.style.left = "-260px"; mc.style.marginLeft = "0"; }
  else { sb.style.left = "0"; mc.style.marginLeft = "240px"; }
  sidebarVisible = !sidebarVisible;
}
/* ---------- OPEN / PREVIEW ---------- */
function clearPreview(){ const p = document.getElementById("previewArea"); if(p) p.remove(); }
function renderPreview(title, htmlContent){
  clearPreview();
  const main = document.getElementById("main-area");
  if(!main) return;
  const preview = document.createElement("div");
  preview.id = "previewArea"; preview.className = "preview";
  preview.innerHTML = `<h4>${escapeHtml(title)} <button class="close-preview" onclick="clearPreview()">Close</button></h4>${htmlContent}`;
  main.prepend(preview);
  preview.scrollIntoView({behavior:'smooth',block:'start'});
}


/* ---------- LOAD CONTENT ---------- */
function loadContent(section){
  const main = document.getElementById("main-area");
  if(!main) return;
  localStorage.setItem("lastSection", section);
  clearPreview();

  if(section === 'materials'){
    if(role === 'teacher'){
      main.innerHTML = `
        <h2>üìò Upload Study Materials ‚Äî Teacher</h2>
        <div class="categories" id="categoryRow"></div>
        <div id="teacher-subtopic-area"></div>
        <div id="teacher-file-list" style="margin-top:12px;"></div>
      `;
      const row = document.getElementById("categoryRow");
      Object.keys(CATEGORIES).forEach(cat => {
        const btn = document.createElement("button"); btn.className = "cat-btn";
        btn.innerText = CATEGORIES[cat].label;
        btn.onclick = () => showTeacherSubtopic(cat);
        row.appendChild(btn);
      });
    } else {
      main.innerHTML = `
        <h2>üìò Study Materials</h2>
        <div class="categories" id="student-category-row"></div>
        <div id="student-subtopic-area"></div>
      `;
      const row = document.getElementById("student-category-row");
      Object.keys(CATEGORIES).forEach(cat => {
        const btn = document.createElement("button"); btn.className = "cat-btn";
        btn.innerText = CATEGORIES[cat].label;
        btn.onclick = () => showStudentSubtopics(cat);
        row.appendChild(btn);
      });
    }
  } else if(section === 'videos'){
    if(role === 'teacher'){
      main.innerHTML = `
        <h2>üé• Upload Videos ‚Äî Teacher</h2>
        <div class="categories" id="videoCategoryRow"></div>
        <div id="teacher-video-subtopic-area"></div>
        <div id="teacher-video-list" style="margin-top:12px;"></div>
      `;
      const row = document.getElementById("videoCategoryRow");
      Object.keys(CATEGORIES).forEach(cat => {
        const btn = document.createElement("button"); btn.className = "cat-btn";
        btn.innerText = CATEGORIES[cat].label;
        btn.onclick = () => showTeacherVideoSubtopic(cat);
        row.appendChild(btn);
      });
    } else {
      main.innerHTML = `
        <h2>üé• Video Lessons</h2>
        <div class="categories" id="student-video-category-row"></div>
        <div id="student-video-subtopic-area"></div>
      `;
      const row = document.getElementById("student-video-category-row");
      Object.keys(CATEGORIES).forEach(cat => {
        const btn = document.createElement("button"); btn.className = "cat-btn";
        btn.innerText = CATEGORIES[cat].label;
        btn.onclick = () => showStudentVideoSubtopics(cat);
        row.appendChild(btn);
      });
    }
  } else if(section === 'tasks'){
    if(role === 'teacher'){
      main.innerHTML = `
        <h2>üìù Tasks ‚Äî Teacher</h2>
        <div style="margin-top:8px;">
          <input type="text" id="taskText" placeholder="Enter task description" style="width:70%;padding:8px;border-radius:6px;border:1px solid #ccc" />
          <button onclick="uploadFile('task')">Add Task</button>
        </div>
        <ul class="resource-list" id="taskList" style="margin-top:12px;"></ul>
      `;
      displayUploaded('task');
    } else {
      fetch(MOCKAPI_URL).then(r=>r.json()).then(data=>{
        const tasks = data.filter(i => i.type === 'task');
        const html = tasks.length ? tasks.map(t => `<li>üìù ${escapeHtml(t.name)} <span class="meta">(${formatDate(t.uploadedAt)})</span></li>`).join('') : "<li>No tasks yet.</li>";
        main.innerHTML = `<h2>üìù Assignments</h2><ul class="resource-list">${html}</ul>`;
      }).catch(()=>{ main.innerHTML = `<h2>üìù Assignments</h2><p style="color:red">Unable to load tasks.</p>`; });
    }
  }
}


/* ===== openFile (works with data URLs and hosted URLs) ===== */
function openFile(dataURL, name){
  clearPreview();
  if(typeof dataURL !== 'string'){ renderPreview(name||'Preview', "<p>Preview not available.</p>"); return; }
  const lower = dataURL.toLowerCase();
  if(lower.startsWith("data:")){
    if(lower.startsWith("data:application/pdf")){
      renderPreview(name, `<iframe src="${dataURL}" style="width:100%;height:70vh;border-radius:8px;border:none"></iframe>`);
      return;
    } else if(lower.startsWith("data:image/")){
      renderPreview(name, `<div style="text-align:center"><img src="${dataURL}" alt="${escapeHtml(name)}" style="max-width:100%;border-radius:6px"/></div>
        <p style="text-align:center;margin-top:8px"><a class="small-btn" href="${dataURL}" download="${escapeHtml(name)}">Download ${escapeHtml(name)}</a></p>`);
      return;
    } else if(lower.startsWith("data:video/")){
      renderPreview(name, `<video controls style="width:100%;max-height:70vh;border-radius:8px"><source src="${dataURL}">Your browser does not support the video tag.</video>`);
      return;
    }
  }
  // treat as a normal URL
  try{
    const urlObj = new URL(dataURL);
    if(dataURL.includes("youtube.com") || dataURL.includes("youtu.be")){
      let embed = dataURL.includes("watch?v=") ? dataURL.replace("watch?v=", "embed/") : dataURL.includes("youtu.be/") ? dataURL.replace("youtu.be/", "www.youtube.com/embed/") : dataURL;
      renderPreview(name, `<iframe src="${embed}" style="width:100%;height:60vh;border-radius:8px;border:none"></iframe>`);
      return;
    }
    const ext = urlObj.pathname.split('.').pop().toLowerCase();
    if(ext === "pdf"){
      renderPreview(name, `<iframe src="${dataURL}" style="width:100%;height:70vh;border-radius:8px;border:none"></iframe>`);
      return;
    } else if(["png","jpg","jpeg","gif","webp"].includes(ext)){
      renderPreview(name, `<div style="text-align:center"><img src="${dataURL}" alt="${escapeHtml(name)}" style="max-width:100%;border-radius:6px"/></div>
        <p style="text-align:center;margin-top:8px"><a class="small-btn" href="${dataURL}" download="${escapeHtml(name)}">Download ${escapeHtml(name)}</a></p>`);
      return;
    } else if(["mp4","webm","ogg"].includes(ext)){
      renderPreview(name, `<video controls style="width:100%;max-height:70vh;border-radius:8px"><source src="${dataURL}">Your browser does not support the video tag.</video>`);
      return;
    }
    renderPreview(name, `<p>Preview not available inline. <a href="${dataURL}" target="_blank">Open ${escapeHtml(name)} in a new tab</a></p>`);
  } catch(e){
    renderPreview(name, `<p>Preview not available. <a href="${dataURL}" target="_blank">Open in new tab</a></p>`);
  }
}


function logout(){ localStorage.removeItem("current_user"); location.reload(); }

/* ---------- TEACHER: Materials ---------- */
function showTeacherSubtopic(categoryKey){
  const area = document.getElementById("teacher-subtopic-area");
  if(!area) return;
  const subList = CATEGORIES[categoryKey].subs;
  let inner = `<h3 style="margin-top:12px">${CATEGORIES[categoryKey].label} ‚Äî Select Subtopic</h3><div class="subcats">`;
  subList.forEach(s => inner += `<button class="cat-btn" onclick="renderTeacherUpload('${categoryKey}','${s}')">${SUB_LABELS[s]||s}</button>`);
  inner += `</div>`;
  area.innerHTML = inner;
  const fl = document.getElementById("teacher-file-list");
  if(fl) fl.innerHTML = "";
}

function renderTeacherUpload(categoryKey, subKey){
  const fileListDiv = document.getElementById("teacher-file-list");
  if(!fileListDiv) return;
  fileListDiv.innerHTML = `
    <h4 style="margin-top:12px">${CATEGORIES[categoryKey].label} ‚Üí ${SUB_LABELS[subKey] || subKey}</h4>
    <div class="upload-form">
      <input type="file" id="uploadFile" multiple />
      <div><button onclick="uploadFile('pdf','${categoryKey}','${subKey}')">Upload File(s)</button></div>
    </div>
    <ul class="resource-list" id="materialList" style="margin-top:12px;"></ul>
  `;
  // attach change listener safely (element exists now)
 const input = document.getElementById("uploadFile");
  if(input){
    input.addEventListener("change", function() {
      const file = this.files[0];
      if (file && file.size > 20 * 1024 * 1024) { // 20 MB limit
        alert("File size must be less than 20 MB!");
        this.value = "";
      }
    });
  }
  displayUploaded('pdf', categoryKey, subKey);
}

/* ---------- TEACHER: Videos ---------- */
function showTeacherVideoSubtopic(categoryKey){
  const area = document.getElementById("teacher-video-subtopic-area");
  if(!area) return;
  const subList = CATEGORIES[categoryKey].subs;
  let inner = `<h3 style="margin-top:12px">${CATEGORIES[categoryKey].label} ‚Äî Select Subtopic (Video)</h3><div class="subcats">`;
  subList.forEach(s => inner += `<button class="cat-btn" onclick="renderTeacherVideoUpload('${categoryKey}','${s}')">${SUB_LABELS[s]||s}</button>`);
  inner += `</div>`;
  area.innerHTML = inner;
  const fl = document.getElementById("teacher-video-list"); if(fl) fl.innerHTML = "";
}

function renderTeacherVideoUpload(categoryKey, subKey){
  const listDiv = document.getElementById("teacher-video-list");
  if(!listDiv) return;
  listDiv.innerHTML = `
    <h4 style="margin-top:12px">${CATEGORIES[categoryKey].label} ‚Üí ${SUB_LABELS[subKey] || subKey} (Videos)</h4>
    <div class="upload-form">
      <input type="text" id="videoLink" placeholder="YouTube link (optional)" style="width:70%;padding:8px;border-radius:6px;border:1px solid #ccc"/>
      <div style="font-size:13px;color:#555">OR upload MP4 file:</div>
      <input type="file" id="videoFile" accept="video/mp4" />
      <div style="margin-top:8px;"><button onclick="uploadFile('video','${categoryKey}','${subKey}')">Add Video</button></div>
    </div>
    <ul class="resource-list" id="videoList" style="margin-top:12px;"></ul>
  `;
  const vf = document.getElementById("videoFile");
  if(vf) vf.addEventListener("change", function(){ if(this.files[0] && this.files[0].size > 50 * 1024 * 1024){ alert("Video must be less than 50 MB"); this.value = ""; } });
  displayUploaded('video', categoryKey, subKey);
}

// ‚úÖ Upload file / video / task to MockAPI and refresh list
function uploadFile(type, categoryKey, subKey) {

  // ---------------- PDF UPLOAD (metadata only) ----------------
  if (type === 'pdf') {
    const input = document.getElementById("uploadFile");
    if (!input || !input.files.length) return alert("Select file(s).");

    const files = Array.from(input.files);

    for (const file of files) {
      fetch(MOCKAPI_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: file.name,
          // fileUrl: "<UPLOAD_URL_IF_YOU_ADD_STORAGE_LATER>",
          category: categoryKey,
          subcategory: subKey,
          type: "pdf",
          uploadedAt: new Date().toISOString()
        })
      }).then(() => displayUploaded('pdf', categoryKey, subKey));
    }

    alert("‚úÖ File metadata uploaded successfully!");
    input.value = "";
  }


  // ---------------- VIDEO UPLOAD (UNCHANGED) ----------------
  else if (type === 'video') {
    const linkEl = document.getElementById("videoLink");
    if (!linkEl) return alert("Video input not found.");

    const link = linkEl.value.trim();
    if (!link) return alert("Enter video URL.");

    fetch(MOCKAPI_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: link,
        link: link,
        category: categoryKey,
        subcategory: subKey,
        type: "video",
        uploadedAt: new Date().toISOString()
      })
    }).then(() => displayUploaded('video', categoryKey, subKey));

    alert("‚úÖ Video link saved!");
    linkEl.value = "";
  }


  // ---------------- TASK UPLOAD ----------------
  else if (type === 'task') {
    const tEl = document.getElementById("taskText");
    if (!tEl) return alert("Task input not found.");

    const text = tEl.value.trim();
    if (!text) return alert("Enter task.");

    fetch(MOCKAPI_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: text,
        category: "task",
        subcategory: "general",
        type: "task",
        uploadedAt: new Date().toISOString()
      })
    }).then(() => displayUploaded('task'));

    alert("‚úÖ Task added!");
    tEl.value = "";
  }

}



/* ====== Display uploaded (Teacher view) ====== */
function displayUploaded(type, categoryKey, subKey) {
  fetch(MOCKAPI_URL)
    .then(res => res.json())
    .then(data => {
      let filtered;
      if (type === 'pdf')
        filtered = data.filter(i => i.category === categoryKey && i.subcategory === subKey && i.type === 'pdf');
      else if (type === 'video')
        filtered = data.filter(i => i.category === categoryKey && i.subcategory === subKey && i.type === 'video');
      else if (type === 'task')
        filtered = data.filter(i => i.type === 'task');
      else return;

      const listEl = type === 'task' ? document.getElementById("taskList")
        : type === 'video' ? document.getElementById("videoList")
        : document.getElementById("materialList");

      if (!listEl) return;
      listEl.innerHTML = "";

      if (filtered.length === 0) {
        listEl.innerHTML = "<li>No data uploaded yet.</li>";
        return;
      }

      filtered.forEach((item) => {
        let content = "";
        if (type === 'pdf') content = `üìÑ ${item.name}`;
        if (type === 'video') content = `üé• <a href="${item.link || item.name}" target="_blank">${item.name}</a>`;
        if (type === 'task') content = `üìù ${item.name}`;

        const li = document.createElement("li");
        li.innerHTML = `${content} <span class="meta">(${new Date(item.uploadedAt).toLocaleString()})</span>`;

        const delBtn = document.createElement("button");
        delBtn.className = "small-btn";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => deleteFromMockAPI(item.id, type, categoryKey, subKey);

        li.appendChild(delBtn);
        listEl.appendChild(li);
      });
    })
    .catch(err => {
      console.error("Fetch failed", err);
      // ignore silently in teacher view
    });
}

/* ---------- DELETE ---------- */
function deleteFromMockAPI(id, type, categoryKey, subKey) {
  if(!confirm("Are you sure you want to delete this item?")) return;
  fetch(`${MOCKAPI_URL}/${id}`, { method: "DELETE" })
    .then(()=> { alert("üóëÔ∏è Deleted successfully!"); displayUploaded(type, categoryKey, subKey); })
    .catch(err => { console.error("Delete failed", err); alert("‚ùå Failed to delete item."); });
}

/* ---------- STUDENT: View (global) ---------- */
function showStudentSubtopics(categoryKey) {
  const area = document.getElementById("student-subtopic-area");
  if(!area) return;
  const subList = CATEGORIES[categoryKey].subs;
  let inner = `<h3 style="margin-top:12px">${CATEGORIES[categoryKey].label} ‚Äî Select Subtopic</h3><div class="subcats">`;
  subList.forEach(s => inner += `<button class="cat-btn" onclick="showStudentFiles('${categoryKey}','${s}')">${SUB_LABELS[s] || s}</button>`);
  inner += `</div><div id="student-file-list" style="margin-top:12px;"></div>`;
  area.innerHTML = inner;
}
function showStudentFiles(categoryKey, subKey) {
  clearPreview();

  const key = `teacher_uploads_${categoryKey}_${subKey}`;
  const arr = JSON.parse(localStorage.getItem(key)) || [];

  let html = arr.length ? "" : "<li>No files uploaded yet.</li>";

  arr.forEach(f => {

    // Base64 ‚Üí Blob convert
    const byteString = atob(f.data.split(',')[1]);
    const byteArray = new Uint8Array(byteString.length);
    for (let i = 0; i < byteString.length; i++) {
      byteArray[i] = byteString.charCodeAt(i);
    }

    const blob = new Blob([byteArray], { type: f.type });
    const fileURL = URL.createObjectURL(blob);

    html += `
      <li style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span>üìÑ ${escapeHtml(f.name)}</span>
        <span>
          <button class="small-btn" onclick="openFile('${fileURL}')">Open</button>
          <a href="${fileURL}" download="${escapeHtml(f.name)}">
            <button class="small-btn">Download</button>
          </a>
        </span>
      </li>
    `;
  });

  const container = document.getElementById("student-file-list");
  if (container) {
    container.innerHTML = `<ul class="resource-list">${html}</ul>`;
  }
}

function openFile(url) {
  window.open(url, "_blank");
}

/* Student videos */
function showStudentVideoSubtopics(categoryKey){
  const area = document.getElementById("student-video-subtopic-area");
  if(!area) return;
  const subList = CATEGORIES[categoryKey].subs;
  let inner = `<h3 style="margin-top:12px">${CATEGORIES[categoryKey].label} ‚Äî Video Subtopics</h3><div class="subcats">`;
  subList.forEach(s => inner += `<button class="cat-btn" onclick="showStudentVideoFiles('${categoryKey}','${s}')">${SUB_LABELS[s]||s}</button>`);
  inner += `</div><div id="student-video-list" style="margin-top:12px;"></div>`;
  area.innerHTML = inner;
}

function showStudentVideoFiles(categoryKey, subKey){
  clearPreview();
  const container = document.getElementById("student-video-list");
  if(!container) return;
  container.innerHTML = "<p>Loading...</p>";
  fetch(MOCKAPI_URL)
    .then(res=>res.json())
    .then(data=>{
      const filtered = data.filter(v => v.category === categoryKey && v.subcategory === subKey && v.type === 'video');
      if(filtered.length === 0){ container.innerHTML = "<li>No videos uploaded yet.</li>"; return; }
      const html = filtered.map(v => `
        <li style="display:flex;justify-content:space-between;align-items:center">
          <span>üé• ${escapeHtml(v.name)} <span class="meta">(${formatDate(v.uploadedAt)})</span></span>
          <span>
            <button class="small-btn" onclick='openFile("${v.url || v.name}", "${escapeHtml(v.name)}")'>Open</button>
            ${v.url && !v.url.includes('youtube.com') && !v.url.includes('youtu.be') ? `<a class="small-btn" href="${v.url}" download="${escapeHtml(v.name)}">Download</a>` : ''}
          </span>
        </li>
      `).join('');
      container.innerHTML = `<ul class="resource-list">${html}</ul>`;
    })
    .catch(err=>{ console.error(err); container.innerHTML = "<p style='color:red'>Unable to load videos.</p>"; });
}

</script>
</body>
</html>
